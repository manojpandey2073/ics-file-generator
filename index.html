<section id="banner_event">
<form id="ics_form">
   <div class="form_heading">
     <h3>
       {{ module.form_top_heading }}
      </h3>
   </div>
        <label>Email</label>
        <input type="email" id="i_email" name="email" required>
        <span id="emailError" style="color: red; font-size: 0.9em;"></span>
        <label for="options">{{ module.event_heading }}</label>
        <select id="options" name="selectedOption">
          <option value="" disabled selected>Select huddle</option>
          
          {% for item in module.huddles %}
          <option value="option{{loop.index}}">{{ item.huddle_title }}</option>
{{ item.datetime_field }}
          {% endfor %}
         
        </select>
         <span id="optionError" style="color: red; font-size: 0.9em;"></span>
        <button type="button" id="generateICSButton">Submit</button>
      </form>
</section>
{% require_css %}
<style>
{% scope_css %}
  form{
    display: flex;
    flex-direction: column;
    gap: 10px!important;
    justify-content: center;
    align-items: flex-start;
    max-width:500px;
    width:100%;
    background-color:#ffffff;
    margin: auto;
    padding: 30px 30px;
    -webkit-box-shadow: 3px 6px 5px -1px rgba(0,0,0,0.75);
-moz-box-shadow: 3px 6px 5px -1px rgba(0,0,0,0.75);
box-shadow: 3px 6px 5px -1px rgba(0,0,0,0.75);

    }
 form input[type=email], form select{
   min-height: 2.75rem;
   padding:0 10px;
  }
  button{
    display: inline-block;
    padding: 16px 24px;
    border-radius: 8px;
    background-color:#BCE500;
    color:#1F0536;
    border: none;
  }
  button:hover{
    background-color: #DEC7F9;
  }
  .form_heading{
    text-align: center;
    margin: auto;
  }
    select{
        padding: 20px 10px;
    }
    button{
        padding: 10px 20px;
    }

{% end_scope_css %}
  </style>
{% end_require_css %}

{% require_js %}
<script>
  
   // Function to get query parameters
  function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
  }

  // Populate email input field
  window.onload = function () {
    const email = getQueryParam("email");
    if (email) {
      const emailInput = document.getElementById("i_email"); // Replace with your form's email field ID
      if (emailInput) {
        emailInput.value = decodeURIComponent(email);
      }
    }
  };
  
document.getElementById('generateICSButton').addEventListener('click', function () {
  const emailInput = document.getElementById('i_email');
  const emailValue = emailInput.value;
  const emailError = document.getElementById('emailError');

  const selectedOption = document.getElementById('options').value;
  const optionError = document.getElementById('optionError');

  const hubspotFormUrl = 'https://api.hsforms.com/submissions/v3/integration/submit/24220313/f88eb2cb-e462-4669-ab47-788c868b7da4';

  // Event details
  const eventDetails = {
     {% for item in module.huddles %}
    option{{ loop.index }}: {
      eventName: '{{ item.huddle_title }}',
      dateStart: '{{ item.datetime_field }}',
      duration: 60, // Duration in minutes
      location: '{{ item.location }}',
      description: '{{ item.description }}',
    }{% if not loop.last %},{% endif %}
             {% endfor %}
  };
  

  const eventData = eventDetails[selectedOption];
console.log(eventData);
 
//   formatting date for emails token value
// const date_string= eventData.dateStart;
//   console.log(date_string);
// //   convert string to a date object
// const date_obj= new Date(date_string);
//  console.log(date_obj);

// const options = { weekday:'long', year: 'numeric', month: 'long', day: 'numeric' };
// const formattedDate = date_obj.toLocaleDateString('en-US', options);
// console.log(formattedDate);
  // Clear previous error messages
  emailError.textContent = '';
  optionError.textContent = '';

  // Email validation function
  function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/; // Regex for email validation
    return emailRegex.test(email);
  }

  let isValid = true;

  // Validate email
  if (!emailValue || !isValidEmail(emailValue)) {
    emailError.textContent = 'Please enter a valid email address.';
    emailInput.focus();
    isValid = false;
  }

  // Validate selected option
  if (!selectedOption || !eventData) {
    optionError.textContent = 'Please select a valid event option.';
    isValid = false;
  }

  if (!isValid) {
    return;
  }

  // Proceed with the form submission and ICS generation logic
  const now = new Date();

  // Function to format dates
  function _isofix(d) {
    const offset = ('0' + (new Date().getTimezoneOffset() / 60)).slice(-2);
    if (typeof d === 'string') {
      return d.replace(/-/g, '') + 'T' + offset + '0000Z';
    } else {
      return (
        d.getFullYear() +
        ('0' + (d.getMonth() + 1)).slice(-2) +
        ('0' + d.getDate()).slice(-2) +
        'T' +
        ('0' + d.getHours()).slice(-2) +
        '0000Z'
      );
    }
  }

  const dateStart = new Date(new Date(eventData.dateStart).valueOf() + 21600000);
  const dateEnd = new Date(dateStart.getTime() + eventData.duration * 60000);

//   const ics_lines = [
//     'BEGIN:VCALENDAR',
//     'VERSION:2.0',
//     'PRODID:-//Addroid Inc.//iCalAdUnit//EN',
//     'METHOD:REQUEST',
//     'BEGIN:VEVENT',
//     'UID:event-' + now.getTime() + '@addroid.com',
//     'DTSTAMP:' + _isofix(now),
//     'DTSTART;TZID=America/New_York:' + _isofix(dateStart),
//     'DTEND;TZID=America/New_York:' + _isofix(dateEnd),
//     'DESCRIPTION:' + eventData.eventName,
//     'SUMMARY:' + eventData.eventName,
//     'LOCATION:' + eventData.location,
//     'LAST-MODIFIED:' + _isofix(now),
//     'SEQUENCE:0',
//     'END:VEVENT',
//     'END:VCALENDAR',
//   ];
  const event = {data:{
  start: [dateStart.getFullYear(), dateStart.getMonth() + 1, dateStart.getDate(), dateStart.getHours(), dateStart.getMinutes()],
  duration: { hours: 0, minutes: eventData.duration },
  title: eventData.eventName,
  description: eventData.description,
  location: eventData.location
},
email:emailValue,
                 dateStart:eventData.dateStart
}

  //const dlurl = 'data:text/calendar;base64,' + btoa(ics_lines.join('\r\n'));
  
  // Save ICS file
//   function _save(fileURL) {
//     const save = document.createElement('a');
//     save.href = fileURL;
//     save.target = '_blank';
//     save.download = eventData.eventName || 'unknown';
//     save.dispatchEvent(new MouseEvent('click', { view: window, bubbles: true, cancelable: false }));
//     (window.URL || window.webkitURL).revokeObjectURL(save.href);
//   }
  function _save(event) {
     const myHeaders = new Headers();
     myHeaders.append("Content-Type", "application/json");
     fetch('https://mats.demandtech.org/saveICS',{
			  method: "POST",
			  headers: myHeaders,
			  redirect: "follow",
			  body:JSON.stringify(event)
	 })
	 .then((response)=>{
	     response.text();
	 })
	 .then((result)=>{
	   console.log(result);
	 })
	 .catch((error)=>{
	    console.log(error);
	 })
  }

  try {
    _save(event);
  } catch (e) {
    console.log(e);
  }

  // Prepare HubSpot form data
  const formData = {
    fields: [
      {
        name: 'email',
        value: emailValue,
      },
    ],
    context: {
      pageUri: window.location.href,
      pageName: document.title,
    },
  };

  // Submit data to HubSpot form
  fetch(hubspotFormUrl, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(formData),
  })
    .then((response) => {
      if (response.ok) {
        return response.json();
      } else {
        throw new Error('Form submission failed');
      }
    })
    .then((data) => {
      console.log('Form submission successful:', data);
    window.open("https://pages.cmohuddles.com/thank-you", "_self");
    })
    .catch((error) => {
      console.error('Error submitting form:', error);
      alert('There was an error submitting the form. Please try again.');
    });
  document.getElementById('i_email').value='';
  document.getElementById('options').value='';
  
});
  
</script>
{% end_require_js %}

